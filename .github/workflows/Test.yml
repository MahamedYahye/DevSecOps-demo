# name: Modular SAST Workflow
# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   gitleaks:
#     name: GitLeaks Security Scan
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code with full history
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
          
#       - name: Install GitLeaks
#         run: |
#           wget https://github.com/zricethezav/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
#           tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
#           chmod +x gitleaks
#           sudo mv gitleaks /usr/local/bin/
          
#       - name: Run GitLeaks scan
#         id: gitleaks_scan
#         continue-on-error: true
#         run: |
#           # Scan en sla resultaten op
#           gitleaks detect --source=. --verbose --redact --report-format=json --report-path=gitleaks-results.json
          
#           # Toon bevindingen
#           echo "=== GitLeaks Resultaten ==="
#           if [ -f gitleaks-results.json ]; then
#             FOUND=$(jq 'length' gitleaks-results.json)
            
#             if [ "$FOUND" -gt 0 ]; then
#               echo "‚ö†Ô∏è GitLeaks heeft $FOUND potenti√´le geheimen gevonden"
#               jq -r '.[] | "- \(.Rule): \(.Description) in \(.File)"' gitleaks-results.json
#             else
#               echo "‚úÖ Geen geheimen gevonden"
#             fi
#           fi
          
#       - name: Upload GitLeaks Results
#         uses: actions/upload-artifact@v4
#         with:
#           name: gitleaks-results
#           path: gitleaks-results.json
#           if-no-files-found: warn

#   semgrep:
#     name: Semgrep Scan
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
        
#       - name: Install Semgrep
#         run: |
#           python -m pip install semgrep
        
#       - name: Run Semgrep scan
#         id: semgrep_scan
#         continue-on-error: true
#         run: |
#           # Maak results directory
#           mkdir -p semgrep-results
          
#           # Voer Semgrep uit
#           semgrep --config p/default --json --output semgrep-results/results.json .
          
#           # Toon bevindingen
#           echo "=== Semgrep Resultaten ==="
#           if [ -f semgrep-results/results.json ]; then
#             FINDINGS=$(jq '.results | length' semgrep-results/results.json)
            
#             if [ "$FINDINGS" -gt 0 ]; then
#               echo "‚ö†Ô∏è Semgrep heeft $FINDINGS bevindingen gedetecteerd"
#               jq -r '.results[] | "- \(.check_id): \(.extra.message) in \(.path):\(.start.line)"' semgrep-results/results.json
#             else
#               echo "‚úÖ Geen bevindingen gedetecteerd"
#             fi
#           else
#             echo "Geen Semgrep resultaten gevonden"
#           fi
          
#       - name: Upload Semgrep Results
#         uses: actions/upload-artifact@v4
#         with:
#           name: semgrep-results
#           path: semgrep-results/
#           if-no-files-found: warn

#   bandit:
#     name: Bandit Security Scan
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
        
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
          
#       - name: Install Bandit
#         run: |
#           python -m pip install bandit
          
#       - name: Run Bandit
#         id: bandit_scan
#         continue-on-error: true
#         run: |
#           # Maak results directory
#           mkdir -p bandit-results
          
#           # Productie-level scan
#           bandit -r . -ll -f json -o bandit-results/results.json || true
          
#           # Toon bevindingen
#           if [ -f bandit-results/results.json ]; then
#             echo "=== Beveiligingsproblemen ==="
#             HIGH_COUNT=$(jq '.results | map(select(.issue_severity == "HIGH")) | length' bandit-results/results.json)
#             MEDIUM_COUNT=$(jq '.results | map(select(.issue_severity == "MEDIUM")) | length' bandit-results/results.json)
#             LOW_COUNT=$(jq '.results | map(select(.issue_severity == "LOW")) | length' bandit-results/results.json)
#             TOTAL=$((HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
            
#             echo "Hoog: $HIGH_COUNT, Gemiddeld: $MEDIUM_COUNT, Laag: $LOW_COUNT, Totaal: $TOTAL"
            
#             if [ "$TOTAL" -gt 0 ]; then
#               jq -r '.results[] | "[\(.issue_severity)] \(.issue_text) in \(.filename) lijn \(.line_number)"' bandit-results/results.json
#             fi
#           fi
          
#       - name: Upload Bandit Results
#         uses: actions/upload-artifact@v4
#         with:
#           name: bandit-results
#           path: bandit-results/
#           if-no-files-found: warn

# # # Deze job toevoegen aan het einde van Test.yml
#   upload_scan_results:
#     name: Upload Scan Results to Security Tools
#     runs-on: ubuntu-latest
#     needs: [gitleaks, semgrep, bandit]  # Wacht tot alle scan jobs zijn afgerond
#     steps:
#       # Download artifacts
#       - name: Download Gitleaks Results
#         uses: actions/download-artifact@v4
#         with:
#           name: gitleaks-results
#           path: gitleaks-results

#       - name: Download Semgrep Results
#         uses: actions/download-artifact@v4
#         with:
#           name: semgrep-results
#           path: semgrep-results

#       - name: Download Bandit Results
#         uses: actions/download-artifact@v4
#         with:
#           name: bandit-results
#           path: bandit-results

#       # Upload alle scans naar DefectDojo
#       - name: Upload All Scans to DefectDojo
#         env:
#           DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
#           DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
#           DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
#         run: |
#           upload_scan_to_defectdojo() {
#             local file="$1"
#             local scan_type="$2"
#             local scan_name="$3"
            
#             # Datum en tijd voor de scan
#             SCAN_DATE=$(date +"%Y-%m-%d")
#             SCAN_TIME=$(date +"%H:%M:%S")
#             echo "‚åõ Uploading $scan_name scan (date: $SCAN_DATE, time: $SCAN_TIME)"
            
#             curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
#               -H "Authorization: Token $DEFECTDOJO_API_KEY" \
#               -F "scan_date=$SCAN_DATE" \
#               -F "scan_type=$scan_type" \
#               -F "test_title=$scan_name Scan $SCAN_DATE $SCAN_TIME" \
#               -F "tags=time_$SCAN_TIME" \
#               -F "description=$scan_name scan uitgevoerd op $SCAN_DATE om $SCAN_TIME" \
#               -F "close_old_findings=true" \
#               -F "deduplication_on_engagement=true" \
#               -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID" \
#               -F "file=@$file"
            
#             echo "‚úÖ $scan_name scan uploaded"
#           }
          
#           # Upload scans
#           # Semgrep
#           upload_scan_to_defectdojo "semgrep-results/results.json" "Semgrep JSON Report" "Semgrep"
          
#           # Gitleaks
#           upload_scan_to_defectdojo "gitleaks-results/gitleaks-results.json" "Gitleaks Scan" "Gitleaks"
          
#           # Bandit
#           upload_scan_to_defectdojo "bandit-results/results.json" "Bandit Scan" "Bandit"


# .github/workflows/checkov-test.yml
name: Checkov Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger voor testing

jobs:
  checkov-test:
    name: Checkov Security Test
    runs-on: ubuntu-latest  # Start met hosted runner voor test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Checkov Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: kubernetes,dockerfile,yaml,secrets
        output_format: cli,json,sarif
        output_file_path: checkov-results
        soft_fail: true
        compact: true
        
    - name: Display Checkov Results Summary
      if: always()
      run: |
        echo "=== Checkov Results Summary ==="
        
        if [ -f checkov-results/results_json.json ]; then
          echo "‚úÖ JSON report generated"
          
          # Show summary stats
          PASSED=$(jq '.summary.passed // 0' checkov-results/results_json.json)
          FAILED=$(jq '.summary.failed // 0' checkov-results/results_json.json)
          SKIPPED=$(jq '.summary.skipped // 0' checkov-results/results_json.json)
          
          echo "üìà Results:"
          echo "  ‚úÖ Passed: $PASSED"
          echo "  ‚ùå Failed: $FAILED" 
          echo "  ‚è≠Ô∏è  Skipped: $SKIPPED"
          
          # Show top 5 failed checks
          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "üîç Top Failed Checks:"
            jq -r '.results.failed_checks[] | "  - \(.severity): \(.check_name) in \(.file_path)"' checkov-results/results_json.json | head -n 5
          fi
        else
          echo "‚ö†Ô∏è No JSON report found"
        fi
        
        if [ -f checkov-results/results_sarif.sarif ]; then
          echo "‚úÖ SARIF report generated"
        else
          echo "‚ö†Ô∏è No SARIF report found"
        fi
        
    - name: Upload Checkov Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: checkov-test-results
        path: checkov-results/
        retention-days: 7
        
    - name: Upload SARIF to GitHub Security
      if: always() && github.event_name != 'pull_request'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov-results/results_sarif.sarif
        
    - name: Test Summary
      if: always()
      run: |
        echo ""
        echo "üéâ Checkov test completed!"
        echo "üìÅ Results uploaded as artifacts"
        echo "üîí SARIF uploaded to Security tab (if on main branch)"
        echo ""
        echo "Next steps:"
        echo "1. Check the Security tab for findings"
        echo "2. Download artifacts to see detailed reports"  
        echo "3. If satisfied, integrate into main security pipeline"